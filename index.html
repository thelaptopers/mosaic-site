<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mosaic Portrait Studio</title>

<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<style>

body{
margin:0;
background:#0f0f0f;
font-family:Arial;
color:white;
text-align:center;
}

.container{
max-width:1100px;
margin:auto;
padding:25px;
}

.panel{
background:#1b1b1b;
padding:25px;
border-radius:12px;
box-shadow:0 15px 50px rgba(0,0,0,.5);
}

button{
background:#4f7cff;
border:none;
padding:12px 18px;
color:white;
border-radius:8px;
margin:8px;
cursor:pointer;
}

.viewer{
overflow:auto;
max-height:75vh;
margin-top:15px;
}

canvas{
background:white;
}

</style>
</head>

<body>

<div class="container">

<h2>Mosaic Portrait Generator</h2>

<div class="panel">

<input type="file" id="upload">
<br>

<button onclick="generate()">Generate</button>
<button onclick="download()">Download</button>

<div class="viewer">
<canvas id="canvas"></canvas>
</div>

</div>

</div>

<script>

const canvas = document.getElementById("canvas")
const ctx = canvas.getContext("2d")

let modelLoaded = false

async function loadModel(){
await faceapi.nets.tinyFaceDetector.loadFromUri(
"https://justadudewhohacks.github.io/face-api.js/models"
)
modelLoaded = true
}

loadModel()

async function generate(){

if(!modelLoaded){
alert("Model still loading. Try again.")
return
}

const file = document.getElementById("upload").files[0]
if(!file) return

const img = new Image()
img.src = URL.createObjectURL(file)

img.onload = async function(){

const detection = await faceapi.detectSingleFace(
img,
new faceapi.TinyFaceDetectorOptions()
)

if(!detection){
alert("Face not detected")
return
}

const b = detection.box

const SIZE = 2400
const TILE = 4

canvas.width = SIZE
canvas.height = SIZE

ctx.drawImage(
img,
b.x,b.y,b.width,b.height,
0,0,SIZE,SIZE
)

let imgData = ctx.getImageData(0,0,SIZE,SIZE)
let d = imgData.data

for(let i=0;i<d.length;i+=4){

let g = d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11

d[i]=g
d[i+1]=g
d[i+2]=g

}

ctx.putImageData(imgData,0,0)

for(let y=0;y<SIZE;y+=TILE){
for(let x=0;x<SIZE;x+=TILE){

let p = ctx.getImageData(x,y,1,1).data

let color = p[0] > 130 ? 255 : 0

ctx.fillStyle=`rgb(${color},${color},${color})`
ctx.fillRect(x,y,TILE,TILE)

}
}

ctx.strokeStyle="rgba(0,0,0,0.25)"

for(let y=0;y<SIZE;y+=TILE){
ctx.beginPath()
ctx.moveTo(0,y)
ctx.lineTo(SIZE,y)
ctx.stroke()
}

for(let x=0;x<SIZE;x+=TILE){
ctx.beginPath()
ctx.moveTo(x,0)
ctx.lineTo(x,SIZE)
ctx.stroke()
}

}

}

function download(){

const a=document.createElement("a")
a.download="mosaic.png"
a.href=canvas.toDataURL()
a.click()

}

</script>

</body>
</html>
